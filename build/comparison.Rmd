---
output: github_document
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(knitr)
opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
# theme_set(theme_bw())
# setwd(here::here())
```

## Kintelligence / k2v SNP count comparison

```{r}
sampledata <- read_tsv(here::here("testdata/HG002.SnpResult.txt"), col_types="ciiicciii")
hg19 <- read_tsv(here::here("build/hg19_mapping.tsv"), col_types="cic")
hg19 <- hg19 %>% transmute(chr=Chromosome %>% gsub("23", "X", .) %>% gsub("24", "Y", .), pos=Position, rsid=RsId)
hg19x <- hg19 %>% semi_join(sampledata, by=c("rsid"="Locus_ID"))
alleletable <- read_csv(here::here("assets/kintelligence.alleles.csv"), col_types = "cicccd")
notk2v <- hg19x %>% 
  anti_join(alleletable, by=c("chr", "pos", "rsid")) %>% 
  mutate(chr=factor(chr, levels=c(as.character(1:22), "X", "Y")))

notk2v_y <- notk2v %>% filter(chr=="Y")
notk2v_noty <- notk2v %>% filter(chr!="Y")
```

k2v joins the `<sample>.SnpResult.txt` to an allele table to get genotypes which are used to convert to VCF. 

Building the k2v allele table starts with the [`hg19_mapping.tsv`](hg19_mapping.tsv) file provided by Verogen, which contains RSIDs, chromosome, and position information for `r scales::comma(nrow(hg19))` SNPs, including `r nrow(hg19 %>% filter(chr=="Y"))` SNPs on the Y chromosome. `r scales::comma(nrow(hg19x))` of these SNPs are genotyped and included in the `<sample>.SnpResult.txt` output, including `r nrow(hg19x %>% filter(chr=="Y"))` SNPs on Y chromosome.

The allele table is created by extracting biallelic SNPs from GnomAD genomes for 1-22 and X using the GRCh37 GnomAD site VCF. Y chromosome sites from GnomAD are not available on GRCh37, so the GRCh38 Y chromosome site VCF from GnomAD is lifted over to GRCh37 prior to extracting Y chromosome Kintelligence sites. Reference and alternate alleles are extracted from the GnomAD site VCF(s) and used for converting 0/0, 0/1, 1/1 genotypes in the `<sample>.SnpResult.txt`.

**`r nrow(notk2v)`** variants are not captured by k2v. These include `r nrow(notk2v_y)` Y chromosome SNPs, and 1 non-Y variant. This variant is rs796296176 (called "N29insA" in the Kintelligence output): a reference C to CA insertion at 16:89985750. This insertion cannot be captured by k2v. The `r nrow(notk2v_y)` Y SNPs not captured by k2v are shown in the table below.

```{r}
notk2v_y %>% 
  knitr::kable(caption="Y chromosome SNPs not captured by k2v. These SNPs are not in the GnomAD GRCh38 site VCF after liftover to GRCh37.")
```
